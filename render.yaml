# ==============================================================
# ü¶ç PittState-Connect ‚Äî Render Deployment Specification
# ==============================================================
# This file defines all Render services used by PittState-Connect:
# - Web Service (Flask + Gunicorn)
# - Redis Cache
# - Environment Variables, Build, and Health Checks
# ==============================================================

services:
  # ------------------------------------------------------------
  # üåê MAIN WEB SERVICE
  # ------------------------------------------------------------
  - type: web
    name: pittstate-connect
    env: python
    region: oregon                  # (change to closest region if desired)
    branch: main
    autoDeploy: true
    runtime: python3
    startCommand: gunicorn app_pro:app

    # ----------------------------------------------------------
    # üì¶ BUILD SETTINGS
    # ----------------------------------------------------------
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt

    # ----------------------------------------------------------
    # ‚öôÔ∏è ENVIRONMENT VARIABLES
    # ----------------------------------------------------------
    envVars:
      # üîë Core Configuration
      - key: FLASK_ENV
        value: production
      - key: PYTHON_VERSION
        value: 3.10.13
      - key: SECRET_KEY
        sync: false                  # Keep in .env.production for security

      # üóÉÔ∏è Database (PostgreSQL on Render)
      - key: DATABASE_URL
        sync: false

      # üß† Redis (linked service below)
      - key: REDIS_URL
        fromService:
          type: redis
          name: pittstate-connect-redis
          property: connectionString

      # üìß Mail Configuration
      - key: MAIL_SERVER
        value: smtp.gmail.com
      - key: MAIL_PORT
        value: "587"
      - key: MAIL_USE_TLS
        value: "True"
      - key: MAIL_USERNAME
        sync: false
      - key: MAIL_PASSWORD
        sync: false
      - key: MAIL_DEFAULT_SENDER
        value: no-reply@pittstate-connect.com

      # üß∞ Admin + Security Tokens
      - key: ADMIN_TOKEN
        sync: false

      # üïí Scheduler + Caching
      - key: FLASK_CACHE_TYPE
        value: RedisCache
      - key: FLASK_CACHE_REDIS_URL
        fromService:
          type: redis
          name: pittstate-connect-redis
          property: connectionString

    # ----------------------------------------------------------
    # ü©∫ HEALTH CHECK
    # ----------------------------------------------------------
    healthCheckPath: /health
    healthCheckTimeout: 60
    healthCheckIntervalSeconds: 15
    autoDeployOnGitCommit: true

    # ----------------------------------------------------------
    # üî• INSTANCE SPECS
    # ----------------------------------------------------------
    plan: starter                   # Options: free | starter | standard | pro
    numInstances: 1
    envVarsFromFiles:
      - path: .env.production       # Securely load environment variables

    # ----------------------------------------------------------
    # üîß SERVICE HOOKS
    # ----------------------------------------------------------
    preDeployCommand: |
      echo "üîç Running database migrations..."
      flask db upgrade || echo "‚ö†Ô∏è Database migration skipped."
      echo "‚úÖ Build complete, preparing to serve app..."

    postDeployCommand: |
      echo "üéâ PittState-Connect successfully deployed and live!"

  # ------------------------------------------------------------
  # üß† REDIS SERVICE
  # ------------------------------------------------------------
  - type: redis
    name: pittstate-connect-redis
    plan: free                      # You can upgrade to starter | standard later
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []                 # Default (public Render VPC)
    # Redis automatically links to web service through env vars above.

# ==============================================================
# üõ†Ô∏è NOTES
# ==============================================================
# 1. Gunicorn starts app_pro:app (matches your Flask app factory export)
# 2. All sensitive values like SECRET_KEY and DATABASE_URL
#    should be stored in Render‚Äôs Environment tab or .env.production
# 3. Flask-Moment and Redis caching auto-initialize via app_pro.py
# 4. Logs: Check the Render dashboard ‚Üí "Logs" for each deploy
# 5. To redeploy manually: click ‚ÄúManual Deploy ‚Üí Clear build cache ‚Üí Deploy‚Äù
# ==============================================================

