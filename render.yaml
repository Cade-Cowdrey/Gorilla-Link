# =============================================================
# RENDER DEPLOY CONFIG ‚Äî PittState-Connect
# Advanced production config for Flask (factory pattern)
# =============================================================

services:
  - type: web
    name: pittstate-connect
    env: python
    region: oregon

    # -------------------------------
    # STARTUP COMMAND (factory call)
    # -------------------------------
    startCommand: gunicorn 'app_pro:create_app()' \
      --workers 3 \
      --threads 2 \
      --timeout 120 \
      --preload \
      --bind 0.0.0.0:$PORT

    # -------------------------------
    # BUILD SETTINGS
    # -------------------------------
    buildCommand: |
      pip install --upgrade pip setuptools wheel
      pip install -r requirements.txt
      echo "‚úÖ Build complete: dependencies installed"

    # -------------------------------
    # ENVIRONMENT SETTINGS
    # -------------------------------
    envVars:
      # Core Flask settings
      - key: FLASK_ENV
        value: production
      - key: PYTHON_VERSION
        value: 3.10.13
      - key: APP_NAME
        value: PittState-Connect
      - key: SECRET_KEY
        generateValue: true

      # ---------------------------
      # Database
      # ---------------------------
      - key: DATABASE_URL
        sync: false    # Set in Render Dashboard or external DB service

      # ---------------------------
      # Mail / SendGrid
      # ---------------------------
      - key: MAIL_SERVER
        value: smtp.gmail.com
      - key: MAIL_PORT
        value: 587
      - key: MAIL_USE_TLS
        value: true
      - key: MAIL_USERNAME
        sync: false
      - key: MAIL_PASSWORD
        sync: false
      - key: MAIL_DEFAULT_SENDER
        value: "no-reply@pittstateconnect.edu"

      # ---------------------------
      # AI / OpenAI integration
      # ---------------------------
      - key: OPENAI_API_KEY
        sync: false

      # ---------------------------
      # Feature Flags (optional enhancements)
      # ---------------------------
      - key: CAREERS_BOARD_ENABLED
        value: true
      - key: SCHOLARSHIP_HUB_ENABLED
        value: true
      - key: MENTORSHIP_PROGRAM_ENABLED
        value: true
      - key: DONOR_PORTAL_ENABLED
        value: true
      - key: NOTIFICATIONS_ENABLED
        value: true
      - key: DEPARTMENT_PAGES_ENABLED
        value: true
      - key: ANALYTICS_DASHBOARD
        value: true
      - key: ALUMNI_PORTAL_ENABLED
        value: true
      - key: EVENTS_ENABLED
        value: true
      - key: MESSAGING_ENABLED
        value: true

      # ---------------------------
      # Security & Logging
      # ---------------------------
      - key: LOG_LEVEL
        value: info
      - key: SESSION_COOKIE_SECURE
        value: true
      - key: SESSION_COOKIE_SAMESITE
        value: Lax
      - key: PREFERRED_URL_SCHEME
        value: https

      # ---------------------------
      # Analytics / Monitoring (optional)
      # ---------------------------
      - key: ENABLE_ANALYTICS
        value: true
      - key: SENTRY_DSN
        sync: false
      - key: ENABLE_REQUEST_LOGGING
        value: true

    # -------------------------------
    # AUTO DEPLOY + HEALTH
    # -------------------------------
    autoDeploy: true
    plan: standard
    numInstances: 1
    healthCheckPath: /health
    healthCheckTimeout: 30
    envVarsFile: .env.production

    # -------------------------------
    # OPTIONAL STORAGE / LOGGING
    # -------------------------------
    disk:
      name: persistent-data
      mountPath: /opt/render/project/persistent
      sizeGB: 1

    # -------------------------------
    # SCALING (optional performance)
    # -------------------------------
    scaling:
      minInstances: 1
      maxInstances: 3
      targetMemoryPercent: 85
      targetCPUPercent: 75

    # -------------------------------
    # ADVANCED NETWORKING
    # -------------------------------
    headers:
      - key: X-Frame-Options
        value: DENY
      - key: X-Content-Type-Options
        value: nosniff
      - key: Referrer-Policy
        value: no-referrer
      - key: Permissions-Policy
        value: geolocation=(), microphone=(), camera=()

    # -------------------------------
    # POST-DEPLOY HOOKS
    # -------------------------------
    postDeployCommand: |
      echo "üöÄ Running DB migrations..."
      flask db upgrade || echo "‚ö†Ô∏è Skipped migration (no DB)"
      echo "‚úÖ Deployment complete and healthy."
