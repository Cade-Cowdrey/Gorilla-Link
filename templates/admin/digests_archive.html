{% extends "base.html" %}
{% block title %}Digest Archive{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-3">ðŸ“¬ Monthly Analytics Digest Archive</h2>
  {% if current_user.role in ["admin","faculty"] %}
  <form action="{{ url_for('admin_bp.send_digest_now') }}" method="post" class="mb-4">
    <button class="btn btn-warning">Send Monthly Analytics Now</button>
  </form>
  {% endif %}
  {% if digests %}
  <table class="table table-bordered table-striped">
    <thead class="table-dark"><tr><th>Month</th><th>Sent</th><th>Via</th><th>Recipients</th><th>Actions</th></tr></thead>
    <tbody>
    {% for d in digests %}
      <tr>
        <td>{{ d.month_label }}</td>
        <td>{{ d.sent_at.strftime("%b %d %Y %H:%M") if d.sent_at else "" }}</td>
        <td>{{ d.created_via }}</td>
        <td class="small text-muted">{{ d.recipients[:60] ~ ("â€¦" if d.recipients|length>60) }}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#html{{ d.id }}">View</button>
          <form action="{{ url_for('admin_bp.resend_digest', id=d.id) }}" method="post" style="display:inline;">
            <button class="btn btn-sm btn-outline-success">Resend</button>
          </form>
        </td>
      </tr>
      <tr class="collapse" id="html{{ d.id }}">
        <td colspan="5">
          <iframe srcdoc="{{ d.html_snapshot|safe }}" style="width:100%;height:400px;border:1px solid #ccc;border-radius:8px;"></iframe>
          {% if d.resent_at %}<p class="text-muted small mt-1">Resent {{ d.resent_at.strftime("%b %d %Y %H:%M") }}</p>{% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No digests archived yet.</p>
  {% endif %}
</div>
{% endblock %}
