{% extends "base.html" %}
{% block title %}Analytics Dashboard | PittState-Connect{% endblock %}
{% block content %}
<section class="section-light py-5">
  <div class="container fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="font-heading text-crimson">Analytics Dashboard</h1>
      <button id="refresh-analytics" class="btn btn-gold fw-bold">
        <i class="bi bi-arrow-repeat me-2"></i> Refresh Data
      </button>
    </div>

    <!-- ==========================================================
         METRIC CARDS
    =========================================================== -->
    <div class="row g-4 mb-5">
      <div class="col-md-3">
        <div class="card text-center p-4 shadow-sm metric-card" data-key="logins_today">
          <h5 class="text-crimson fw-bold mb-1">Logins Today</h5>
          <h2 id="logins-today" class="display-6 fw-bold text-dark">--</h2>
          <span class="trend small text-gray" id="trend-logins"></span>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center p-4 shadow-sm metric-card" data-key="active_users">
          <h5 class="text-crimson fw-bold mb-1">Active Users</h5>
          <h2 id="active-users" class="display-6 fw-bold text-dark">--</h2>
          <span class="trend small text-gray" id="trend-active"></span>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center p-4 shadow-sm metric-card" data-key="scholarship_apps">
          <h5 class="text-crimson fw-bold mb-1">Scholarship Apps</h5>
          <h2 id="scholarship-apps" class="display-6 fw-bold text-dark">--</h2>
          <span class="trend small text-gray" id="trend-scholarships"></span>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center p-4 shadow-sm metric-card" data-key="jobs_viewed">
          <h5 class="text-crimson fw-bold mb-1">Jobs Viewed</h5>
          <h2 id="jobs-viewed" class="display-6 fw-bold text-dark">--</h2>
          <span class="trend small text-gray" id="trend-jobs"></span>
        </div>
      </div>
    </div>

    <!-- ==========================================================
         TREND CHART SECTION
    =========================================================== -->
    <div class="card p-4 mb-5 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="font-heading text-crimson m-0">Engagement Trends</h4>
        <select id="trend-select" class="form-select w-auto">
          <option value="7">Last 7 Days</option>
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
        </select>
      </div>
      <div id="trend-chart" style="height: 400px;"></div>
    </div>

    <!-- ==========================================================
         AI INSIGHTS PANEL
    =========================================================== -->
    <div class="card p-4 mb-5 shadow-sm">
      <h4 class="font-heading text-crimson mb-3"><i class="bi bi-stars me-2"></i>AI Insights</h4>
      <div id="ai-insight-output" class="p-3 border rounded bg-light mb-3 small" style="min-height: 120px;">
        Ask Gorilla AI to summarize trends, forecast engagement, or identify opportunities.
      </div>
      <div class="input-group">
        <input id="ai-insight-input" type="text" class="form-control" placeholder="Ask about student engagement trendsâ€¦">
        <button id="ai-insight-send" class="btn btn-crimson"><i class="bi bi-send-fill me-1"></i>Ask AI</button>
      </div>
    </div>

    <!-- ==========================================================
         SYSTEM HEALTH + CACHE STATUS
    =========================================================== -->
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card p-4 shadow-sm">
          <h5 class="font-heading text-crimson mb-2">System Health</h5>
          <ul class="list-unstyled mb-0 small">
            <li>ðŸ§  <b>Redis:</b> <span id="redis-status" class="text-muted">checking...</span></li>
            <li>ðŸ“ˆ <b>Scheduler:</b> <span id="scheduler-status" class="text-muted">checking...</span></li>
            <li>ðŸ¤– <b>AI Engine:</b> <span id="ai-status" class="text-muted">checking...</span></li>
          </ul>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card p-4 shadow-sm">
          <h5 class="font-heading text-crimson mb-2">Recent Activity</h5>
          <div id="activity-log" class="small text-gray" style="max-height: 150px; overflow-y: auto;">
            Loading recent eventsâ€¦
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ==========================================================
     INLINE SCRIPT (CSP NONCE SAFE)
=========================================================== -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", () => {
  // --- Live Data Fetch ---
  async function fetchAnalytics() {
    const res = await fetch("/analytics/api/insights");
    const data = await res.json();
    if (data.session_metrics) {
      const m = data.session_metrics;
      document.getElementById("logins-today").textContent = m.logins_today;
      document.getElementById("active-users").textContent = m.new_posts;
      document.getElementById("scholarship-apps").textContent = m.avg_session_time;
      document.getElementById("jobs-viewed").textContent = m.most_active_dept;
    }
  }

  // --- Chart (Plotly) ---
  async function drawChart(days = 7) {
    const x = [...Array(days).keys()].map(d => `Day ${d + 1}`);
    const y = x.map(() => Math.floor(Math.random() * 50) + 20);
    Plotly.newPlot("trend-chart", [{
      x, y,
      type: "scatter",
      mode: "lines+markers",
      line: { color: "#a6192e", width: 3 },
      marker: { color: "#ffb81c", size: 6 }
    }], {
      margin: { t: 10, r: 0, l: 40, b: 40 },
      paper_bgcolor: "transparent",
      plot_bgcolor: "transparent",
      font: { color: document.body.classList.contains("dark") ? "#fff" : "#111" },
    }, { displayModeBar: false });
  }

  // --- AI Insight ---
  async function askAI() {
    const q = document.getElementById("ai-insight-input").value.trim();
    if (!q) return;
    const out = document.getElementById("ai-insight-output");
    out.innerHTML = `<em>Generating insight...</em>`;
    try {
      const res = await fetch("/analytics/ai/trends", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: q })
      });
      const data = await res.json();
      if (data.summary) out.innerHTML = data.summary;
      else out.innerHTML = `<span class="text-danger">Error: ${data.error}</span>`;
    } catch (err) {
      out.innerHTML = `<span class="text-danger">AI request failed.</span>`;
    }
  }

  // --- System Status Check (mocked for now) ---
  function updateHealth() {
    document.getElementById("redis-status").textContent = "âœ… Connected";
    document.getElementById("scheduler-status").textContent = "âœ… Running";
    document.getElementById("ai-status").textContent = "âœ… Online";
  }

  // --- Refresh Button ---
  document.getElementById("refresh-analytics").addEventListener("click", fetchAnalytics);
  document.getElementById("ai-insight-send").addEventListener("click", askAI);
  document.getElementById("trend-select").addEventListener("change", e => drawChart(+e.target.value));

  // --- Initialize ---
  fetchAnalytics();
  drawChart();
  updateHealth();
});
</script>

<script nonce="{{ csp_nonce }}" src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}
