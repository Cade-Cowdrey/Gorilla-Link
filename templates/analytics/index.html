<!-- File: templates/analytics/index.html -->
{% extends "base.html" %}
{% block title %}Analytics | PittState-Connect{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center mb-4">
    <img src="{{ url_for('static', filename='img/psu_gorilla_mark.png') }}" alt="PSU"
         style="height:48px;width:auto;margin-right:12px;">
    <div>
      <h1 class="h3 m-0">PittState-Connect Analytics</h1>
      <div class="text-muted">Real-time usage insights • PSU-branded</div>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="row g-3" id="summary-cards">
    <div class="col-6 col-md-3"><div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-uppercase small text-muted">Page Views (7d)</div>
        <div class="fs-3 fw-bold" id="pv7">–</div>
      </div>
    </div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-uppercase small text-muted">Unique Users (7d)</div>
        <div class="fs-3 fw-bold" id="uu7">–</div>
      </div>
    </div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-uppercase small text-muted">Avg /day (30d)</div>
        <div class="fs-3 fw-bold" id="avg30">–</div>
      </div>
    </div></div>
    <div class="col-6 col-md-3"><div class="card shadow-sm border-0">
      <div class="card-body">
        <div class="text-uppercase small text-muted">Endpoints Tracked</div>
        <div class="fs-3 fw-bold" id="endpoints">–</div>
      </div>
    </div></div>
  </div>

  <!-- Charts -->
  <div class="row g-3 mt-1">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h5 m-0">30-Day Traffic</h2>
            <select id="days" class="form-select form-select-sm" style="width:auto">
              <option value="7">Last 7 days</option>
              <option value="14">Last 14 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
            </select>
          </div>
          <div id="timeseries" style="height:340px;"></div>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h2 class="h5 mb-2">Top Pages</h2>
          <div id="topPages" style="height:340px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Department filter mock (future expansion) -->
  <div class="card shadow-sm border-0 mt-3">
    <div class="card-body">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <span class="text-muted small text-uppercase">Filters:</span>
        <select class="form-select form-select-sm" style="width:auto" disabled title="Coming soon">
          <option>All Departments</option>
        </select>
        <select class="form-select form-select-sm" style="width:auto" disabled title="Coming soon">
          <option>All Roles</option>
        </select>
        <span class="badge bg-warning text-dark">PSU-Branded • Ready for data wiring</span>
      </div>
    </div>
  </div>
</div>

<!-- Plotly (bundled) -->
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  // Summary
  const s = await fetch('{{ url_for("analytics.api_summary") }}').then(r=>r.json());
  document.getElementById('pv7').textContent   = s.page_views_7d ?? '0';
  document.getElementById('uu7').textContent   = s.unique_users_7d ?? '0';
  document.getElementById('avg30').textContent = s.avg_per_day_30d ?? '0';
  document.getElementById('endpoints').textContent = s.endpoints ?? '0';

  // Timeseries
  async function drawSeries(days) {
    const ts = await fetch(`{{ url_for("analytics.api_timeseries") }}?days=${days}`).then(r=>r.json());
    const x = ts.series.map(p=>p.date), y = ts.series.map(p=>p.count);
    Plotly.newPlot('timeseries', [{x, y, mode:'lines+markers', name:'Page Views'}], {
      margin:{t:10,r:10,b:30,l:40},
      xaxis:{title:'Date'},
      yaxis:{title:'Views'},
    }, {displayModeBar:false});
  }
  drawSeries(30);
  document.getElementById('days').addEventListener('change', e => drawSeries(e.target.value));

  // Top Pages
  const top = await fetch('{{ url_for("analytics.api_top_pages") }}?limit=10').then(r=>r.json());
  const labels = top.items.map(i=>i.page), values = top.items.map(i=>i.count);
  Plotly.newPlot('topPages', [{type:'bar', x:values, y:labels, orientation:'h'}], {
    margin:{t:10,r:10,b:20,l:100},
    xaxis:{title:'Views'},
  }, {displayModeBar:false});
});
</script>
{% endblock %}
