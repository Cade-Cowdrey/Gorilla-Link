{% extends "base.html" %}
{% block title %}Analytics • PittState-Connect{% endblock %}

{% block head %}
<style>
  /* KPI cards */
  .kpi-card { border: 0; border-radius: .75rem; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
  .kpi-value { font-size: clamp(1.75rem, 2.4vw, 2.25rem); font-weight: 800; }
  .kpi-label { font-size: .9rem; letter-spacing: .02em; opacity: .85; }

  /* Skeletons */
  .skeleton { position: relative; overflow: hidden; background: rgba(0,0,0,.05); border-radius: .5rem; }
  .skeleton::after { content: ""; position: absolute; inset: 0; transform: translateX(-100%);
    background: linear-gradient(90deg, transparent, rgba(255,255,255,.28), transparent);
    animation: shimmer 1.2s infinite; }
  @keyframes shimmer { 100% { transform: translateX(100%);} }

  /* Chart */
  .chart-wrap { border-radius: .75rem; background: #fff; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
  @media (prefers-color-scheme: dark) {
    .chart-wrap, .kpi-card { background: #1f1f1f; }
    .skeleton { background: rgba(255,255,255,.05); }
  }

  /* Table */
  .table thead th { border-top: 0; }
  .badge-trend { font-weight: 600; }

  /* AI panel */
  .ai-summary { border-left: .25rem solid {{ PSU_BRAND.crimson|default("#990000") }}; }

  /* Utilities */
  .cursor-pointer { cursor: pointer; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <div>
    <h1 class="h3 mb-0">Analytics Dashboard</h1>
    <div class="text-muted small">PittState-Connect • Real-time insights</div>
  </div>
  <div class="d-flex gap-2">
    <a id="btn-export-pdf"
       class="btn btn-outline-secondary"
       href="{{ url_for('analytics.monthly_pdf', month=request.args.get('month', now().month), year=request.args.get('year', now().year), department_id=request.args.get('department_id')) }}">
      <i class="bi bi-filetype-pdf me-1"></i> Export PDF
    </a>
    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#emailModal">
      <i class="bi bi-send-fill me-1"></i> Email Report
    </button>
  </div>
</div>

<!-- Filters -->
<form id="filters" class="row g-2 align-items-end mb-4">
  <div class="col-6 col-md-3">
    <label class="form-label">Month</label>
    <select class="form-select" name="month" id="month">
      {% for m in range(1,13) %}
        <option value="{{ m }}" {% if (request.args.get('month')|int if request.args.get('month') else now().month) == m %}selected{% endif %}>
          {{ ("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec").split()[m-1] }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-6 col-md-3">
    <label class="form-label">Year</label>
    <select class="form-select" name="year" id="year">
      {% set y_now = now().year %}
      {% for y in range(y_now-4, y_now+1) %}
        <option value="{{ y }}" {% if (request.args.get('year')|int if request.args.get('year') else y_now) == y %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 col-md-4">
    <label class="form-label">Department (optional)</label>
    <select class="form-select" name="department_id" id="department_id">
      <option value="">All Departments</option>
      {% for d in metrics.get('all_departments', []) %}
        <option value="{{ d.id }}" {% if request.args.get('department_id', type=int) == d.id %}selected{% endif %}>{{ d.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-12 col-md-2 d-grid">
    <button class="btn btn-primary">
      <i class="bi bi-funnel me-1"></i> Apply
    </button>
  </div>
</form>

<!-- KPI Cards -->
<div class="row g-3">
  {% set k = metrics or {} %}
  {% macro kpi_card(icon, label, value, delta, good=True) -%}
    <div class="col-6 col-lg-3">
      <div class="card kpi-card">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div class="kpi-value">{{ value|default(0) }}</div>
            <i class="bi {{ icon }} fs-3 opacity-75"></i>
          </div>
          <div class="d-flex align-items-center gap-2 mt-1">
            <div class="kpi-label text-muted">{{ label }}</div>
            {% if delta is not none %}
              <span class="badge rounded-pill badge-trend {% if good %}text-bg-success{% else %}text-bg-danger{% endif %}">
                {% if delta >= 0 %}<i class="bi bi-arrow-up-right"></i>{% else %}<i class="bi bi-arrow-down-right"></i>{% endif %}
                {{ (delta|float)|round(1) }}%
              </span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {%- endmacro %}

  {{ kpi_card("bi-people-fill","Active Users", k.get("users"), k.get("users_delta", 0), good=k.get("users_delta",0)>=0) }}
  {{ kpi_card("bi-chat-dots-fill","Posts", k.get("posts"), k.get("posts_delta", 0), good=k.get("posts_delta",0)>=0) }}
  {{ kpi_card("bi-mortarboard-fill","Scholarships", k.get("scholarships"), k.get("scholarships_delta", 0), good=k.get("scholarships_delta",0)>=0) }}
  {{ kpi_card("bi-building","Departments", k.get("departments"), None, good=True) }}
</div>

<!-- AI Summary -->
{% if metrics.get("ai_summary") %}
<div class="card my-4 ai-summary">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <div class="text-uppercase small text-muted mb-1">AI Summary</div>
        <div class="fw-semibold">{{ metrics.ai_summary }}</div>
      </div>
      <button class="btn btn-sm btn-outline-secondary" id="copySummary" aria-label="Copy AI summary"><i class="bi bi-clipboard"></i></button>
    </div>
  </div>
</div>
{% endif %}

<!-- Chart + Top Departments -->
<div class="row g-4 align-items-stretch">
  <div class="col-12 col-lg-7">
    <div class="chart-wrap p-3 h-100">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h6 mb-0">Engagement Trend</h2>
        <span class="text-muted small">{{ metrics.get('period_label') or "Last 12 months" }}</span>
      </div>
      <div id="chartContainer" class="mt-2">
        {% if metrics.get("chart_img_base64") %}
          <img src="{{ metrics.chart_img_base64 }}" class="img-fluid rounded" alt="Engagement chart" />
        {% else %}
          <div class="skeleton" style="height:260px;"></div>
          <div class="text-muted small mt-2">Generating chart…</div>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-5">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div class="fw-semibold">Top Departments</div>
        <span class="text-muted small">by activity</span>
      </div>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">Department</th>
              <th scope="col" class="text-end">Users</th>
              <th scope="col" class="text-end">Posts</th>
            </tr>
          </thead>
          <tbody>
            {% for row in metrics.get('top_departments', []) %}
            <tr>
              <td>{{ row.name }}</td>
              <td class="text-end">{{ row.users }}</td>
              <td class="text-end">
                {{ row.posts }}
                {% set delta = row.get('posts_delta', 0) %}
                {% if delta is not none %}
                  <span class="ms-2 badge {% if delta>=0 %}text-bg-success{% else %}text-bg-danger{% endif %}">
                    {% if delta>=0 %}+{% endif %}{{ delta|round(1) }}%
                  </span>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="3" class="text-center text-muted py-4">No department data</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="card-footer small text-muted">
        Updated {{ now().strftime('%b %d, %Y %H:%M UTC') }}
      </div>
    </div>
  </div>
</div>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="emailForm" class="modal-content" method="post" action="{{ url_for('analytics.monthly_email') }}">
      <div class="modal-header">
        <h5 class="modal-title" id="emailModalLabel">Email Monthly Report</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" ></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Recipients (comma-separated)</label>
          <input type="text" class="form-control" name="recipients" id="recipients" placeholder="admin@pittstate.edu, dean@pittstate.edu" required>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Month</label>
            <input type="number" min="1" max="12" class="form-control" name="month" id="emailMonth" value="{{ request.args.get('month', now().month) }}">
          </div>
          <div class="col-6">
            <label class="form-label">Year</label>
            <input type="number" min="2000" class="form-control" name="year" id="emailYear" value="{{ request.args.get('year', now().year) }}">
          </div>
        </div>
        <input type="hidden" name="department_id" id="emailDepartmentId" value="{{ request.args.get('department_id','') }}">
        <div class="form-text">We’ll generate the PDF and attach it to the email.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
        <button class="btn btn-primary" type="submit"><i class="bi bi-send me-1"></i> Send</button>
      </div>
    </form>
  </div>
</div>

<!-- Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
  <div id="toast" class="toast align-items-center text-bg-dark border-0" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMsg">Action complete.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Helpers
  const showToast = (msg) => {
    const t = document.getElementById('toast');
    document.getElementById('toastMsg').textContent = msg;
    bootstrap.Toast.getOrCreateInstance(t, { delay: 2200 }).show();
  };

  // Persist filters (localStorage)
  const form = document.getElementById('filters');
  const keys = ['month','year','department_id'];
  const storageKey = 'psu:analytics:filters';
  const readFilters = () => {
    try { return JSON.parse(localStorage.getItem(storageKey)) || {}; } catch { return {}; }
  };
  const writeFilters = (obj) => {
    localStorage.setItem(storageKey, JSON.stringify(obj));
  };

  // On load, prime fields from storage if not in URL
  document.addEventListener('DOMContentLoaded', () => {
    const url = new URL(window.location);
    const hasAny = keys.some(k => url.searchParams.has(k));
    if (!hasAny) {
      const saved = readFilters();
      keys.forEach(k => {
        if (saved[k]) {
          const el = document.getElementById(k);
          if (el) el.value = saved[k];
        }
      });
    }

    // Copy AI summary
    const copyBtn = document.getElementById('copySummary');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        const txt = "{{ (metrics.get('ai_summary') or '')|replace('\n',' ')|e }}";
        try { await navigator.clipboard.writeText(txt); showToast('AI summary copied.'); }
        catch { showToast('Could not copy.'); }
      });
    }
  });

  // Submit filters -> navigate, and persist
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const fd = new FormData(form);
    const obj = Object.fromEntries(fd.entries());
    writeFilters(obj);
    const url = new URL(window.location);
    Object.entries(obj).forEach(([k,v]) => { if (v) url.searchParams.set(k, v); else url.searchParams.delete(k); });
    window.location = url.toString();
  });

  // Wire Email modal values from filters
  const emailMonth = document.getElementById('emailMonth');
  const emailYear = document.getElementById('emailYear');
  const emailDepartmentId = document.getElementById('emailDepartmentId');
  document.getElementById('emailModal').addEventListener('show.bs.modal', () => {
    const f = new FormData(form);
    emailMonth.value = f.get('month') || emailMonth.value;
    emailYear.value = f.get('year') || emailYear.value;
    emailDepartmentId.value = f.get('department_id') || '';
  });

  // Email POST (ajax)
  document.getElementById('emailForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    // Expand "recipients" comma separated -> list for backend
    const rec = (fd.get('recipients') || '').split(',').map(s => s.trim()).filter(Boolean);
    fd.delete('recipients');
    rec.forEach(r => fd.append('recipients', r));
    try {
      const res = await fetch(e.target.action, { method: 'POST', body: fd });
      const json = await res.json();
      if (json.ok) {
        bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
        showToast('Report emailed successfully.');
      } else {
        showToast('Email failed.');
      }
    } catch (err) {
      showToast('Network error while emailing.');
    }
  });

  // Client-side cache of last metrics payload (for instant back/refresh UX)
  try {
    const cacheKey = 'psu:analytics:lastMetrics';
    const payload = {{ metrics | tojson | safe }};
    localStorage.setItem(cacheKey, JSON.stringify({ t: Date.now(), data: payload }));
  } catch {}
</script>
{% endblock %}
