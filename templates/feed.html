{% extends "base.html" %}
{% block content %}
<h2 class="fw-bold text-danger mb-4">Student & Alumni Feed</h2>

<!-- ─────────────── POST TO FEED FORM ─────────────── -->
{% if logged_in %}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <form method="POST" action="{{ url_for('feed_bp.create_post') }}" enctype="multipart/form-data">
      <h5 class="fw-bold text-danger mb-3">Post to Feed</h5>
      <input type="text" name="title" class="form-control mb-2" placeholder="Title (optional)">
      <textarea name="content" class="form-control mb-2" rows="3" placeholder="Share an update, question, or opportunity..."></textarea>
      
      <label class="fw-bold">Attach Image (optional)</label>
      <input type="file" name="image" id="imageInput" accept="image/*" class="form-control mb-3">
      
      <!-- Image preview area -->
      <div id="imagePreview" class="text-center mb-3" style="display:none;">
        <img id="previewImg" src="#" alt="Preview" class="img-fluid rounded shadow-sm" style="max-height:300px;object-fit:cover;">
      </div>

      <button class="btn btn-danger w-100">Post</button>
    </form>
  </div>
</div>
{% endif %}

<!-- ─────────────── FILTER BY DEPARTMENT ─────────────── -->
<div class="mb-3">
  <label for="dept" class="form-label fw-bold">Filter by Department</label>
  <select id="dept" class="form-select" onchange="filterDepartment()">
    <option value="">All Departments</option>
    {% for dept in departments %}
    <option value="{{ dept.name }}">{{ dept.name }}</option>
    {% endfor %}
  </select>
</div>

<!-- ─────────────── FEED POSTS ─────────────── -->
<div id="feedContainer">
  {% for post in posts %}
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="fw-bold text-danger mb-0">{{ post.title }}</h5>
          <small class="text-muted">
            <a href="/profile/{{ post.author_id }}" class="text-decoration-none">
              {{ post.author }}
            </a>
            {% if logged_in and post.author_id in connected_user_ids %}
              • <span class="badge bg-success">Connected</span>
            {% endif %}
            • {{ post.department or 'General' }}
            • {{ post.created_at }}
          </small>
        </div>
      </div>

      {% if post.content %}
      <p class="mt-2 mb-0">{{ post.content }}</p>
      {% endif %}

      {% if post.image_url %}
      <img src="{{ post.image_url }}" alt="Post image"
           class="img-fluid rounded mt-2"
           style="max-height:400px;object-fit:cover;">
      {% endif %}
    </div>
  </div>
  {% else %}
  <p>No posts found.</p>
  {% endfor %}
</div>

<!-- ─────────────── JS: Filter + Image Preview ─────────────── -->
<script>
async function filterDepartment() {
  const dept = document.getElementById('dept').value;
  const url = dept ? `/feed/department/${dept}` : `/feed/`;
  const res = await fetch(url);
  const data = await res.json();
  const feed = document.getElementById('feedContainer');
  feed.innerHTML = '';
  const posts = data.posts || [];
  posts.forEach(p => {
    feed.innerHTML += `
      <div class="card mb-3 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="fw-bold text-danger mb-0">${p.title}</h5>
              <small class="text-muted">
                <a href="/profile/${p.author_id}" class="text-decoration-none">${p.author}</a>
                ${p.is_connected ? '• <span class="badge bg-success">Connected</span>' : ''}
                • ${p.department || 'General'} • ${p.created_at}
              </small>
            </div>
          </div>
          ${p.content ? `<p class="mt-2 mb-0">${p.content}</p>` : ''}
          ${p.image_url ? `<img src="${p.image_url}" alt="Post image" class="img-fluid rounded mt-2" style="max-height:400px;object-fit:cover;">` : ''}
        </div>
      </div>`;
  });
  if (posts.length === 0) feed.innerHTML = '<p>No posts found.</p>';
}

document.getElementById('imageInput')?.addEventListener('change', function(event) {
  const file = event.target.files[0];
  const previewContainer = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');

  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      previewImg.src = e.target.result;
      previewContainer.style.display = 'block';
    };
    reader.readAsDataURL(file);
  } else {
    previewContainer.style.display = 'none';
  }
});
</script>
{% endblock %}
