{% extends "base.html" %}

{% block title %}Chat with {{ mentor.full_name }} | PittState Connect{% endblock %}

{% block head %}
<!-- Socket.IO for real-time messaging -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="height: calc(100vh - 100px);">
  <div class="row h-100">
    <!-- Chat Sidebar -->
    <div class="col-md-3 d-none d-md-block">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Conversations</h5>
        </div>
        <div class="card-body p-0" style="overflow-y: auto;">
          <a href="{{ url_for('mentors.index') }}" class="btn btn-light w-100 border-bottom rounded-0">
            <i class="bi bi-arrow-left"></i> Back to Mentors
          </a>
          <!-- Could add conversation list here -->
        </div>
      </div>
    </div>
    
    <!-- Chat Main Area -->
    <div class="col-md-9">
      <div class="card h-100 d-flex flex-column">
        <!-- Chat Header -->
        <div class="card-header bg-white border-bottom">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              {% if mentor.profile_image_url %}
              <img src="{{ mentor.profile_image_url }}" 
                   alt="{{ mentor.full_name }}"
                   class="rounded-circle me-3"
                   style="width: 50px; height: 50px; object-fit: cover;">
              {% else %}
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3"
                   style="width: 50px; height: 50px; font-size: 1.2rem; font-weight: bold;">
                {{ mentor.full_name[0]|upper }}
              </div>
              {% endif %}
              
              <div>
                <h5 class="mb-0">{{ mentor.full_name }}</h5>
                <small class="text-muted">
                  <span id="onlineStatus">
                    <i class="bi bi-circle-fill text-secondary" style="font-size: 0.5rem;"></i>
                    Checking status...
                  </span>
                </small>
              </div>
            </div>
            
            <div class="d-flex gap-2">
              <a href="{{ url_for('profile.view', user_id=mentor.id) }}" 
                 class="btn btn-sm btn-outline-primary" 
                 title="View Profile">
                <i class="bi bi-person"></i>
              </a>
              <button class="btn btn-sm btn-outline-secondary" id="toggleNotifications" title="Toggle Notifications">
                <i class="bi bi-bell"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Chat Messages -->
        <div class="card-body p-3 flex-grow-1" 
             id="chatMessages" 
             style="overflow-y: auto; max-height: calc(100vh - 300px);">
          
          {% if messages|length == 0 %}
          <div class="text-center text-muted py-5">
            <i class="bi bi-chat-quote" style="font-size: 3rem;"></i>
            <p class="mt-3">Start your conversation with {{ mentor.full_name }}</p>
            <p class="small">Send a message to break the ice!</p>
          </div>
          {% else %}
            {% for message in messages %}
            <div class="message-bubble mb-3 {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}"
                 data-message-id="{{ message.id }}">
              <div class="d-flex {% if message.sender_id == current_user.id %}justify-content-end{% endif %}">
                <div class="message-content" style="max-width: 70%;">
                  {% if message.sender_id != current_user.id %}
                  <div class="d-flex align-items-center mb-1">
                    {% if mentor.profile_image_url %}
                    <img src="{{ mentor.profile_image_url }}" 
                         class="rounded-circle me-2"
                         style="width: 25px; height: 25px; object-fit: cover;">
                    {% else %}
                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2"
                         style="width: 25px; height: 25px; font-size: 0.7rem;">
                      {{ mentor.full_name[0]|upper }}
                    </div>
                    {% endif %}
                    <small class="text-muted">{{ mentor.full_name }}</small>
                  </div>
                  {% endif %}
                  
                  <div class="message-text p-3 rounded-3 
                              {% if message.sender_id == current_user.id %}
                              bg-primary text-white
                              {% else %}
                              bg-light
                              {% endif %}">
                    {{ message.body }}
                  </div>
                  
                  <div class="message-meta mt-1 small text-muted">
                    <span>{{ message.created_at.strftime('%I:%M %p') }}</span>
                    {% if message.sender_id == current_user.id %}
                      {% if message.is_read %}
                      <i class="bi bi-check2-all text-primary" title="Read"></i>
                      {% else %}
                      <i class="bi bi-check2" title="Sent"></i>
                      {% endif %}
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          {% endif %}
        </div>
        
        <!-- Typing Indicator -->
        <div id="typingIndicator" class="px-3 pb-2" style="display: none; min-height: 30px;">
          <small class="text-muted">
            <i class="bi bi-three-dots"></i> {{ mentor.full_name }} is typing...
          </small>
        </div>
        
        <!-- Chat Input -->
        <div class="card-footer bg-white border-top">
          <form id="messageForm" class="d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary" id="attachFile" title="Attach File">
              <i class="bi bi-paperclip"></i>
            </button>
            
            <input type="text" 
                   id="messageInput" 
                   class="form-control" 
                   placeholder="Type your message..." 
                   autocomplete="off"
                   required>
            
            <button type="button" class="btn btn-outline-secondary" id="emojiPicker" title="Add Emoji">
              <i class="bi bi-emoji-smile"></i>
            </button>
            
            <button type="submit" class="btn btn-primary" id="sendButton">
              <i class="bi bi-send-fill"></i> Send
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.message-bubble.sent {
  animation: slideInRight 0.3s ease;
}

.message-bubble.received {
  animation: slideInLeft 0.3s ease;
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

#chatMessages::-webkit-scrollbar {
  width: 8px;
}

#chatMessages::-webkit-scrollbar-track {
  background: #f1f1f1;
}

#chatMessages::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

#chatMessages::-webkit-scrollbar-thumb:hover {
  background: #555;
}

.message-text {
  word-wrap: break-word;
}
</style>

<script>
const THREAD_ID = "{{ thread_id }}";
const MENTOR_ID = {{ mentor.id }};
const CURRENT_USER_ID = {{ current_user.id }};
const MENTOR_NAME = "{{ mentor.full_name }}";
const MENTOR_AVATAR = "{{ mentor.profile_image_url or '' }}";

// Initialize Socket.IO
const socket = io({
  transports: ['websocket', 'polling']
});

let typingTimeout;
let notificationsEnabled = true;

// Socket connection handlers
socket.on('connect', function() {
  console.log('‚úÖ Connected to chat server');
  
  // Join room for this user to receive messages
  socket.emit('join_room', {
    room_id: `user_${CURRENT_USER_ID}`,
    user_id: CURRENT_USER_ID
  });
  
  // Check mentor online status
  checkOnlineStatus();
});

socket.on('disconnect', function() {
  console.log('‚ùå Disconnected from chat server');
});

// Receive new messages
socket.on('new_message', function(data) {
  console.log('üì® New message received:', data);
  
  if (data.thread_id === THREAD_ID && data.sender_id === MENTOR_ID) {
    appendMessage(data);
    scrollToBottom();
    
    // Play notification sound
    if (notificationsEnabled && document.hidden) {
      playNotificationSound();
      showBrowserNotification(data);
    }
    
    // Mark as read
    markMessageAsRead(data.message_id);
  }
});

// Typing indicator
socket.on('user_typing', function(data) {
  if (data.user_id === MENTOR_ID && data.is_typing) {
    document.getElementById('typingIndicator').style.display = 'block';
    scrollToBottom();
  } else {
    document.getElementById('typingIndicator').style.display = 'none';
  }
});

// Online status updates
socket.on('user_online', function(data) {
  if (data.user_id === MENTOR_ID) {
    updateOnlineStatus(true);
  }
});

socket.on('user_offline', function(data) {
  if (data.user_id === MENTOR_ID) {
    updateOnlineStatus(false);
  }
});

// Message form handler
document.getElementById('messageForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const input = document.getElementById('messageInput');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Disable input while sending
  input.disabled = true;
  document.getElementById('sendButton').disabled = true;
  
  try {
    const response = await fetch('{{ url_for("mentors.send_message") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        recipient_id: MENTOR_ID,
        message: message,
        thread_id: THREAD_ID
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Append sent message
      appendMessage({
        message_id: data.message_id,
        sender_id: CURRENT_USER_ID,
        sender_name: '{{ current_user.full_name }}',
        sender_avatar: '{{ current_user.profile_image_url or "" }}',
        body: message,
        timestamp: data.timestamp,
        is_read: false
      });
      
      // Clear input
      input.value = '';
      scrollToBottom();
    } else {
      alert('Failed to send message: ' + data.error);
    }
  } catch (error) {
    console.error('Error sending message:', error);
    alert('Failed to send message. Please try again.');
  } finally {
    input.disabled = false;
    document.getElementById('sendButton').disabled = false;
    input.focus();
  }
});

// Typing indicator (emit when user types)
let isTyping = false;
document.getElementById('messageInput').addEventListener('input', function() {
  if (!isTyping) {
    isTyping = true;
    socket.emit('typing', {
      room_id: `user_${MENTOR_ID}`,
      user_id: CURRENT_USER_ID,
      is_typing: true
    });
  }
  
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    isTyping = false;
    socket.emit('typing', {
      room_id: `user_${MENTOR_ID}`,
      user_id: CURRENT_USER_ID,
      is_typing: false
    });
  }, 2000);
});

// Helper functions
function appendMessage(data) {
  const chatMessages = document.getElementById('chatMessages');
  const isSent = data.sender_id === CURRENT_USER_ID;
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message-bubble mb-3 ${isSent ? 'sent' : 'received'}`;
  messageDiv.dataset.messageId = data.message_id;
  
  let avatarHtml = '';
  if (!isSent) {
    if (MENTOR_AVATAR) {
      avatarHtml = `<img src="${MENTOR_AVATAR}" class="rounded-circle me-2" style="width: 25px; height: 25px; object-fit: cover;">`;
    } else {
      avatarHtml = `<div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 25px; height: 25px; font-size: 0.7rem;">${MENTOR_NAME[0].toUpperCase()}</div>`;
    }
  }
  
  const timestamp = new Date(data.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
  
  messageDiv.innerHTML = `
    <div class="d-flex ${isSent ? 'justify-content-end' : ''}">
      <div class="message-content" style="max-width: 70%;">
        ${!isSent ? `<div class="d-flex align-items-center mb-1">${avatarHtml}<small class="text-muted">${data.sender_name}</small></div>` : ''}
        <div class="message-text p-3 rounded-3 ${isSent ? 'bg-primary text-white' : 'bg-light'}">
          ${escapeHtml(data.body)}
        </div>
        <div class="message-meta mt-1 small text-muted">
          <span>${timestamp}</span>
          ${isSent ? (data.is_read ? '<i class="bi bi-check2-all text-primary"></i>' : '<i class="bi bi-check2"></i>') : ''}
        </div>
      </div>
    </div>
  `;
  
  chatMessages.appendChild(messageDiv);
}

function scrollToBottom() {
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function checkOnlineStatus() {
  try {
    const response = await fetch(`{{ url_for('mentors.online_status', user_id=0) }}`.replace('/0', `/${MENTOR_ID}`));
    const data = await response.json();
    updateOnlineStatus(data.is_online, data.last_seen);
  } catch (error) {
    console.error('Error checking online status:', error);
  }
}

function updateOnlineStatus(isOnline, lastSeen = null) {
  const statusEl = document.getElementById('onlineStatus');
  
  if (isOnline) {
    statusEl.innerHTML = '<i class="bi bi-circle-fill text-success" style="font-size: 0.5rem;"></i> Online';
  } else if (lastSeen) {
    const lastSeenDate = new Date(lastSeen);
    const timeAgo = getTimeAgo(lastSeenDate);
    statusEl.innerHTML = `<i class="bi bi-circle-fill text-secondary" style="font-size: 0.5rem;"></i> Last seen ${timeAgo}`;
  } else {
    statusEl.innerHTML = '<i class="bi bi-circle-fill text-secondary" style="font-size: 0.5rem;"></i> Offline';
  }
}

function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  
  if (seconds < 60) return 'just now';
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return `${Math.floor(seconds / 86400)}d ago`;
}

async function markMessageAsRead(messageId) {
  try {
    await fetch(`{{ url_for('mentors.mark_read', message_id=0) }}`.replace('/0', `/${messageId}`), {
      method: 'POST'
    });
  } catch (error) {
    console.error('Error marking message as read:', error);
  }
}

function playNotificationSound() {
  // Simple notification beep
  const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZizUIFmS56+ehUR4JPZ7g7bNkHgU7k9nywn0nBC5+zPLTgjMGHm7A7OGXSAwXY7fs6KFRFApEoOHvvXAjBS2AzvLajDcIF2e76+mgURwJPJ/h7bVnHwU9lNjyxoEqBSl6y/HYiToFGmm87OihUhkJRqLi7r14JwUueM3x2Yo4CBdqu+vpoVcZCT6h4+65ayEFOpPZ88GBKwUrlc3y2Is4CBxmu+znoVIZCTyg4u+4biMFLYHO8tmLNwgXaLvt559NDAw=');
  audio.play().catch(e => console.log('Could not play sound:', e));
}

function showBrowserNotification(data) {
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(`New message from ${data.sender_name}`, {
      body: data.body.substring(0, 100),
      icon: data.sender_avatar || '/static/images/logo.png'
    });
  }
}

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}

// Toggle notifications
document.getElementById('toggleNotifications').addEventListener('click', function() {
  notificationsEnabled = !notificationsEnabled;
  const icon = this.querySelector('i');
  
  if (notificationsEnabled) {
    icon.className = 'bi bi-bell';
    this.classList.remove('btn-outline-danger');
    this.classList.add('btn-outline-secondary');
  } else {
    icon.className = 'bi bi-bell-slash';
    this.classList.remove('btn-outline-secondary');
    this.classList.add('btn-outline-danger');
  }
});

// Emoji picker (simple implementation)
document.getElementById('emojiPicker').addEventListener('click', function() {
  const emojis = ['üòä', 'üëç', '‚ù§Ô∏è', 'üéâ', 'üôè', 'üí™', 'üéì', 'üíº', 'üöÄ', '‚ú®'];
  const emoji = emojis[Math.floor(Math.random() * emojis.length)];
  const input = document.getElementById('messageInput');
  input.value += emoji;
  input.focus();
});

// File attachment placeholder
document.getElementById('attachFile').addEventListener('click', function() {
  alert('File attachment coming soon! For now, you can share links in your messages.');
});

// Scroll to bottom on load
scrollToBottom();
</script>
{% endblock %}
