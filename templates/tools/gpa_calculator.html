{% extends "base.html" %}
{% block title %}GPA Calculator | Gorilla Link{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-gray-50 to-white py-12">
  <div class="max-w-6xl mx-auto px-6">
    
    <!-- Header -->
    <div class="text-center mb-12">
      <div class="inline-block h-1 w-24 bg-gradient-to-r from-[#A6192E] to-[#FFCC33] mb-6"></div>
      <h1 class="text-5xl font-bold mb-4" style="color: #A6192E; font-family: 'Roboto Condensed', sans-serif;">
        GPA Calculator
      </h1>
      <p class="text-xl text-gray-700 max-w-2xl mx-auto">
        Accurate GPA calculation with credit hour weighting. Plan your semester and track your academic progress.
      </p>
    </div>

    <!-- Calculator Mode Tabs -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
      <div class="flex border-b border-gray-200 mb-8">
        <button onclick="switchTab('semester')" id="tab-semester" class="px-6 py-3 font-bold border-b-4 border-[#A6192E] text-[#A6192E]">
          Semester GPA
        </button>
        <button onclick="switchTab('cumulative')" id="tab-cumulative" class="px-6 py-3 font-bold border-b-4 border-transparent text-gray-500 hover:text-[#A6192E]">
          Cumulative GPA
        </button>
        <button onclick="switchTab('whatif')" id="tab-whatif" class="px-6 py-3 font-bold border-b-4 border-transparent text-gray-500 hover:text-[#A6192E]">
          What-If Analysis
        </button>
      </div>

      <!-- Semester GPA Calculator -->
      <div id="semester-calculator" class="calculator-section">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Calculate Semester GPA</h2>
        
        <div id="courses-container" class="space-y-4 mb-6">
          <!-- Course rows will be added here dynamically -->
        </div>

        <button onclick="addCourse()" class="mb-6 px-6 py-3 bg-[#FFCC33] text-[#1C1C1C] font-bold rounded-lg hover:bg-[#e6b82e] transition-all">
          <i class="fas fa-plus mr-2"></i>Add Course
        </button>

        <button onclick="calculateSemesterGPA()" class="w-full py-4 bg-[#A6192E] text-white font-bold rounded-xl hover:bg-[#8a1525] transition-all shadow-lg text-lg">
          <i class="fas fa-calculator mr-2"></i>Calculate Semester GPA
        </button>

        <!-- Results -->
        <div id="semester-results" class="mt-8 hidden">
          <!-- Results will be displayed here -->
        </div>
      </div>

      <!-- Cumulative GPA Calculator -->
      <div id="cumulative-calculator" class="calculator-section hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Calculate Cumulative GPA</h2>
        
        <div class="grid md:grid-cols-2 gap-6 mb-8 p-6 bg-gray-50 rounded-lg">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Current GPA</label>
            <input type="number" id="current-gpa" step="0.01" min="0" max="4.0" placeholder="3.25" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Current Credits Completed</label>
            <input type="number" id="current-credits" step="1" min="0" placeholder="45" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent">
          </div>
        </div>

        <h3 class="text-xl font-bold mb-4 text-gray-800">New Courses This Semester</h3>
        <div id="courses-container-cum" class="space-y-4 mb-6">
          <!-- Course rows will be added here dynamically -->
        </div>

        <button onclick="addCourseCumulative()" class="mb-6 px-6 py-3 bg-[#FFCC33] text-[#1C1C1C] font-bold rounded-lg hover:bg-[#e6b82e] transition-all">
          <i class="fas fa-plus mr-2"></i>Add Course
        </button>

        <button onclick="calculateCumulativeGPA()" class="w-full py-4 bg-[#A6192E] text-white font-bold rounded-xl hover:bg-[#8a1525] transition-all shadow-lg text-lg">
          <i class="fas fa-calculator mr-2"></i>Calculate Cumulative GPA
        </button>

        <!-- Results -->
        <div id="cumulative-results" class="mt-8 hidden">
          <!-- Results will be displayed here -->
        </div>
      </div>

      <!-- What-If Analysis -->
      <div id="whatif-calculator" class="calculator-section hidden">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">What-If GPA Analysis</h2>
        <p class="text-gray-600 mb-8">Calculate what GPA you need to reach your target cumulative GPA.</p>
        
        <div class="grid md:grid-cols-2 gap-6 mb-8">
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Current GPA</label>
            <input type="number" id="whatif-current-gpa" step="0.01" min="0" max="4.0" placeholder="3.0" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Current Credits</label>
            <input type="number" id="whatif-current-credits" step="1" min="0" placeholder="60" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Target GPA</label>
            <input type="number" id="whatif-target-gpa" step="0.01" min="0" max="4.0" placeholder="3.5" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-bold text-gray-700 mb-2">Upcoming Credits</label>
            <input type="number" id="whatif-upcoming-credits" step="1" min="1" placeholder="15" 
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent">
          </div>
        </div>

        <button onclick="calculateWhatIf()" class="w-full py-4 bg-[#A6192E] text-white font-bold rounded-xl hover:bg-[#8a1525] transition-all shadow-lg text-lg">
          <i class="fas fa-chart-line mr-2"></i>Calculate Required GPA
        </button>

        <!-- Results -->
        <div id="whatif-results" class="mt-8 hidden">
          <!-- Results will be displayed here -->
        </div>
      </div>
    </div>

    <!-- Grade Scale Reference -->
    <div class="bg-gradient-to-br from-[#A6192E]/5 to-white rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold mb-6" style="color: #A6192E;">PSU Grade Scale (4.0 System)</h2>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-6">
        <div class="bg-white p-6 rounded-lg text-center shadow-lg">
          <div class="text-4xl font-bold text-green-600 mb-2">A</div>
          <div class="text-2xl text-gray-600">4.0</div>
        </div>
        <div class="bg-white p-6 rounded-lg text-center shadow-lg">
          <div class="text-4xl font-bold text-blue-600 mb-2">B</div>
          <div class="text-2xl text-gray-600">3.0</div>
        </div>
        <div class="bg-white p-6 rounded-lg text-center shadow-lg">
          <div class="text-4xl font-bold text-yellow-600 mb-2">C</div>
          <div class="text-2xl text-gray-600">2.0</div>
        </div>
        <div class="bg-white p-6 rounded-lg text-center shadow-lg">
          <div class="text-4xl font-bold text-orange-600 mb-2">D</div>
          <div class="text-2xl text-gray-600">1.0</div>
        </div>
        <div class="bg-white p-6 rounded-lg text-center shadow-lg">
          <div class="text-4xl font-bold text-red-600 mb-2">F</div>
          <div class="text-2xl text-gray-600">0.0</div>
        </div>
      </div>
      <p class="text-sm text-gray-600 mt-6 text-center">
        <strong>Note:</strong> W (Withdrawn), I (Incomplete), and P (Pass) grades do not count toward GPA calculation.
      </p>
    </div>

  </div>
</div>

<script>
let courseCount = 0;
let courseCountCum = 0;

// Initialize with 4 empty courses
document.addEventListener('DOMContentLoaded', function() {
  for(let i = 0; i < 4; i++) {
    addCourse();
    addCourseCumulative();
  }
});

function switchTab(tab) {
  // Hide all sections
  document.querySelectorAll('.calculator-section').forEach(el => el.classList.add('hidden'));
  
  // Remove active styling from all tabs
  document.querySelectorAll('[id^="tab-"]').forEach(el => {
    el.classList.remove('border-[#A6192E]', 'text-[#A6192E]');
    el.classList.add('border-transparent', 'text-gray-500');
  });
  
  // Show selected section
  document.getElementById(`${tab}-calculator`).classList.remove('hidden');
  
  // Add active styling to selected tab
  const activeTab = document.getElementById(`tab-${tab}`);
  activeTab.classList.remove('border-transparent', 'text-gray-500');
  activeTab.classList.add('border-[#A6192E]', 'text-[#A6192E]');
}

function addCourse() {
  courseCount++;
  const container = document.getElementById('courses-container');
  const courseRow = document.createElement('div');
  courseRow.className = 'grid md:grid-cols-12 gap-4 items-end';
  courseRow.id = `course-${courseCount}`;
  courseRow.innerHTML = `
    <div class="md:col-span-5">
      <label class="block text-sm font-bold text-gray-700 mb-2">Course Name</label>
      <input type="text" placeholder="e.g., CS 1080" 
             class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent course-name">
    </div>
    <div class="md:col-span-3">
      <label class="block text-sm font-bold text-gray-700 mb-2">Grade</label>
      <select class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent course-grade">
        <option value="">Select Grade</option>
        <option value="A">A (4.0)</option>
        <option value="B">B (3.0)</option>
        <option value="C">C (2.0)</option>
        <option value="D">D (1.0)</option>
        <option value="F">F (0.0)</option>
      </select>
    </div>
    <div class="md:col-span-3">
      <label class="block text-sm font-bold text-gray-700 mb-2">Credit Hours</label>
      <input type="number" min="0" max="6" step="0.5" placeholder="3" 
             class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent course-credits">
    </div>
    <div class="md:col-span-1">
      <button onclick="removeCourse(${courseCount})" class="w-full py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  container.appendChild(courseRow);
}

function addCourseCumulative() {
  courseCountCum++;
  const container = document.getElementById('courses-container-cum');
  const courseRow = document.createElement('div');
  courseRow.className = 'grid md:grid-cols-12 gap-4 items-end';
  courseRow.id = `course-cum-${courseCountCum}`;
  courseRow.innerHTML = `
    <div class="md:col-span-5">
      <label class="block text-sm font-bold text-gray-700 mb-2">Course Name</label>
      <input type="text" placeholder="e.g., CS 1080" 
             class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent course-name-cum">
    </div>
    <div class="md:col-span-3">
      <label class="block text-sm font-bold text-gray-700 mb-2">Grade</label>
      <select class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent course-grade-cum">
        <option value="">Select Grade</option>
        <option value="A">A (4.0)</option>
        <option value="B">B (3.0)</option>
        <option value="C">C (2.0)</option>
        <option value="D">D (1.0)</option>
        <option value="F">F (0.0)</option>
      </select>
    </div>
    <div class="md:col-span-3">
      <label class="block text-sm font-bold text-gray-700 mb-2">Credit Hours</label>
      <input type="number" min="0" max="6" step="0.5" placeholder="3" 
             class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#A6192E] focus:border-transparent course-credits-cum">
    </div>
    <div class="md:col-span-1">
      <button onclick="removeCourseCumulative(${courseCountCum})" class="w-full py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  `;
  container.appendChild(courseRow);
}

function removeCourse(id) {
  const courseRow = document.getElementById(`course-${id}`);
  if (courseRow) courseRow.remove();
}

function removeCourseCumulative(id) {
  const courseRow = document.getElementById(`course-cum-${id}`);
  if (courseRow) courseRow.remove();
}

async function calculateSemesterGPA() {
  const courses = [];
  document.querySelectorAll('#courses-container > div').forEach(row => {
    const name = row.querySelector('.course-name').value.trim();
    const grade = row.querySelector('.course-grade').value;
    const credits = parseFloat(row.querySelector('.course-credits').value);
    
    if (name && grade && credits) {
      courses.push({ name, grade, credits });
    }
  });
  
  if (courses.length === 0) {
    alert('Please add at least one course with grade and credits');
    return;
  }
  
  try {
    const response = await fetch('/tools/gpa/calculate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ courses })
    });
    
    const data = await response.json();
    if (response.ok) {
      displaySemesterResults(data);
    } else {
      alert(data.error || 'Calculation failed');
    }
  } catch (error) {
    alert('Error calculating GPA: ' + error.message);
  }
}

async function calculateCumulativeGPA() {
  const currentGPA = parseFloat(document.getElementById('current-gpa').value);
  const currentCredits = parseFloat(document.getElementById('current-credits').value);
  
  if (!currentGPA || !currentCredits) {
    alert('Please enter your current GPA and credits');
    return;
  }
  
  const courses = [];
  document.querySelectorAll('#courses-container-cum > div').forEach(row => {
    const name = row.querySelector('.course-name-cum').value.trim();
    const grade = row.querySelector('.course-grade-cum').value;
    const credits = parseFloat(row.querySelector('.course-credits-cum').value);
    
    if (name && grade && credits) {
      courses.push({ name, grade, credits });
    }
  });
  
  if (courses.length === 0) {
    alert('Please add at least one new course');
    return;
  }
  
  try {
    const response = await fetch('/tools/gpa/calculate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ courses, current_gpa: currentGPA, current_credits: currentCredits })
    });
    
    const data = await response.json();
    if (response.ok) {
      displayCumulativeResults(data);
    } else {
      alert(data.error || 'Calculation failed');
    }
  } catch (error) {
    alert('Error calculating GPA: ' + error.message);
  }
}

async function calculateWhatIf() {
  const currentGPA = parseFloat(document.getElementById('whatif-current-gpa').value);
  const currentCredits = parseFloat(document.getElementById('whatif-current-credits').value);
  const targetGPA = parseFloat(document.getElementById('whatif-target-gpa').value);
  const upcomingCredits = parseFloat(document.getElementById('whatif-upcoming-credits').value);
  
  if (!currentGPA || !currentCredits || !targetGPA || !upcomingCredits) {
    alert('Please fill in all fields');
    return;
  }
  
  try {
    const response = await fetch('/tools/gpa/what-if', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        current_gpa: currentGPA,
        current_credits: currentCredits,
        target_gpa: targetGPA,
        upcoming_credits: upcomingCredits
      })
    });
    
    const data = await response.json();
    if (response.ok) {
      displayWhatIfResults(data);
    } else {
      alert(data.error || 'Calculation failed');
    }
  } catch (error) {
    alert('Error calculating what-if scenario: ' + error.message);
  }
}

function displaySemesterResults(data) {
  const resultsDiv = document.getElementById('semester-results');
  resultsDiv.classList.remove('hidden');
  
  let coursesHTML = '';
  data.courses.forEach(course => {
    coursesHTML += `
      <tr class="border-b">
        <td class="py-3 px-4">${course.name}</td>
        <td class="py-3 px-4 text-center font-bold">${course.grade}</td>
        <td class="py-3 px-4 text-center">${course.credits}</td>
        <td class="py-3 px-4 text-center">${course.quality_points || 'N/A'}</td>
      </tr>
    `;
  });
  
  resultsDiv.innerHTML = `
    <div class="bg-gradient-to-br from-[#A6192E] to-[#8a1525] text-white rounded-xl p-8 mb-6">
      <div class="text-center">
        <div class="text-6xl font-bold mb-2">${data.semester_gpa}</div>
        <div class="text-xl mb-4">Semester GPA</div>
        <div class="text-lg opacity-90">${data.gpa_standing}</div>
        <div class="text-sm opacity-75 mt-2">${data.semester_credits} Credit Hours</div>
      </div>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-100">
          <tr>
            <th class="py-3 px-4 text-left">Course</th>
            <th class="py-3 px-4 text-center">Grade</th>
            <th class="py-3 px-4 text-center">Credits</th>
            <th class="py-3 px-4 text-center">Quality Points</th>
          </tr>
        </thead>
        <tbody>
          ${coursesHTML}
        </tbody>
        <tfoot class="bg-gray-50 font-bold">
          <tr>
            <td class="py-3 px-4">Total</td>
            <td class="py-3 px-4"></td>
            <td class="py-3 px-4 text-center">${data.semester_credits}</td>
            <td class="py-3 px-4 text-center">${data.total_quality_points}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  `;
}

function displayCumulativeResults(data) {
  const resultsDiv = document.getElementById('cumulative-results');
  resultsDiv.classList.remove('hidden');
  
  resultsDiv.innerHTML = `
    <div class="grid md:grid-cols-2 gap-6">
      <div class="bg-gradient-to-br from-[#FFCC33] to-[#e6b82e] text-[#1C1C1C] rounded-xl p-8">
        <div class="text-center">
          <div class="text-sm font-bold mb-2 opacity-75">Semester GPA</div>
          <div class="text-5xl font-bold mb-2">${data.semester_gpa}</div>
          <div class="text-sm">${data.semester_credits} credits</div>
        </div>
      </div>
      
      <div class="bg-gradient-to-br from-[#A6192E] to-[#8a1525] text-white rounded-xl p-8">
        <div class="text-center">
          <div class="text-sm font-bold mb-2 opacity-75">New Cumulative GPA</div>
          <div class="text-5xl font-bold mb-2">${data.cumulative_gpa}</div>
          <div class="text-sm">${data.total_credits} total credits</div>
        </div>
      </div>
    </div>
    
    <div class="mt-6 p-6 bg-green-50 border-l-4 border-green-500 rounded-lg">
      <div class="font-bold text-green-800 mb-2">Academic Standing</div>
      <div class="text-green-700">${data.cumulative_standing}</div>
    </div>
  `;
}

function displayWhatIfResults(data) {
  const resultsDiv = document.getElementById('whatif-results');
  resultsDiv.classList.remove('hidden');
  
  const bgColor = data.achievable ? 'bg-green-50 border-green-500' : 'bg-red-50 border-red-500';
  const textColor = data.achievable ? 'text-green-800' : 'text-red-800';
  const icon = data.achievable ? 'fa-check-circle' : 'fa-exclamation-triangle';
  
  resultsDiv.innerHTML = `
    <div class="${bgColor} border-l-4 rounded-lg p-8">
      <div class="flex items-start gap-4">
        <i class="fas ${icon} text-3xl ${textColor}"></i>
        <div class="flex-1">
          <div class="font-bold text-xl ${textColor} mb-4">
            ${data.achievable ? 'Target is Achievable!' : 'Target May Not Be Achievable'}
          </div>
          
          ${data.required_semester_gpa ? `
            <div class="text-5xl font-bold ${textColor} mb-4">${data.required_semester_gpa}</div>
            <div class="${textColor} mb-4">Required Semester GPA</div>
          ` : ''}
          
          <div class="${textColor} leading-relaxed">
            ${data.recommendation}
          </div>
          
          <div class="mt-6 grid md:grid-cols-2 gap-4 text-sm">
            <div>
              <div class="opacity-75">Current GPA</div>
              <div class="font-bold text-lg">${data.current_gpa}</div>
            </div>
            <div>
              <div class="opacity-75">Target GPA</div>
              <div class="font-bold text-lg">${data.target_gpa}</div>
            </div>
            <div>
              <div class="opacity-75">Current Credits</div>
              <div class="font-bold text-lg">${data.current_credits}</div>
            </div>
            <div>
              <div class="opacity-75">Upcoming Credits</div>
              <div class="font-bold text-lg">${data.upcoming_credits}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}
</script>

{% endblock %}
